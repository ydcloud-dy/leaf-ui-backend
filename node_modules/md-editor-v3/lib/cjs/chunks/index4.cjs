"use strict";const n=require("vue"),R=require("./config.cjs"),y=require("./event-bus.cjs"),G=require("./index5.cjs"),W=require("@vavt/util"),P=`.${R.prefix}-preview > [data-line]`,D=(e,l)=>+getComputedStyle(e).getPropertyValue(l).replace("px",""),j=(e,l)=>{const b=W.debounce(()=>{e.removeEventListener("scroll",i),e.addEventListener("scroll",i),l.removeEventListener("scroll",i),l.addEventListener("scroll",i)},50),i=C=>{const m=e.clientHeight,L=l.clientHeight,d=e.scrollHeight,s=l.scrollHeight,a=(d-m)/(s-L);C.target===e?(l.removeEventListener("scroll",i),l.scrollTo({top:e.scrollTop/a}),b()):(e.removeEventListener("scroll",i),e.scrollTo({top:l.scrollTop*a}),b())};return[()=>{b().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",i),l.removeEventListener("scroll",i)}]},U=(e,l,b)=>{const{view:i}=b,C=W.createSmoothScroll(),m=r=>i.lineBlockAt(i.state.doc.line(r+1).from).top,L=r=>i.lineBlockAt(i.state.doc.line(r+1).from).bottom;let d=[],s=[],a=[];const N=()=>{d=[],s=Array.from(l.querySelectorAll(P)),a=s.map(o=>Number(o.dataset.line));const r=[...a],{lines:g}=i.state.doc;let H=r.shift()||0,t=r.shift()||g;for(let o=0;o<g;o++)o===t&&(H=o,t=r.shift()||g),d.push({start:H,end:t-1})},w=(r,g)=>{let H=1;for(let t=s.length-1;t-1>=0;t--){const o=s[t],f=s[t-1];if(o.offsetTop+o.offsetHeight>g&&f.offsetTop<g){H=Number(f.dataset.line);break}}for(let t=d.length-1;t>=0;t--){const o=L(d[t].end),f=m(d[t].start);if(o>r&&f<=r){H=H<d[t].start?H:d[t].start;break}}return H};let A=0,$=0;const B=()=>{if($!==0)return!1;A++;const{scrollDOM:r,contentHeight:g}=i;let H=D(l,"padding-top");const t=i.lineBlockAtHeight(r.scrollTop),{number:o}=i.state.doc.lineAt(t.from),f=d[o-1];if(!f)return!1;let v=1;const p=l.querySelector(`[data-line="${f.start}"]`)||l.firstElementChild?.firstElementChild,u=l.querySelector(`[data-line="${f.end+1}"]`)||l.lastElementChild?.lastElementChild,c=r.scrollHeight-r.clientHeight,I=l.scrollHeight-l.clientHeight;let T=m(f.start),h=L(f.end),x=p.offsetTop,S=u.offsetTop-x;T===0&&(x=0,p===u?(H=0,h=g-r.offsetHeight,S=I):S=u.offsetTop),v=(r.scrollTop-T)/(h-T);const M=u==l.lastElementChild?.lastElementChild?u.offsetTop+u.clientHeight:u.offsetTop;if(h>=c||M>I){const k=w(c,I);T=m(k),v=(r.scrollTop-T)/(c-T);const q=l.querySelector(`[data-line="${k}"]`);T>0&&q&&(x=q.offsetTop),S=I-x+D(l,"padding-top")}const E=x-H+S*v;C(l,E,()=>{A--})},_=()=>{if(A!==0)return;$++;const{scrollDOM:r}=i,g=l.scrollTop,H=l.scrollHeight,t=r.scrollHeight-r.clientHeight,o=l.scrollHeight-l.clientHeight;let f=l.firstElementChild?.firstElementChild,v=l.firstElementChild?.lastElementChild;if(a.length>0){let M=Math.ceil(a[a.length-1]*(g/H)),E=a.findLastIndex(k=>k<=M);E=E===-1?0:E,M=a[E];for(let k=E;k>=0&&k<a.length;)if(s[k].offsetTop>g){if(k-1>=0){k--;continue}M=-1,E=k;break}else{if(k+1<a.length&&s[k+1].offsetTop<g){k++;continue}M=a[k],E=k;break}switch(E){case-1:{f=l.firstElementChild?.firstElementChild,v=s[E];break}case a.length-1:{f=s[E],v=l.firstElementChild?.lastElementChild;break}default:f=s[E],v=s[E+1===s.length?E:E+1]}}let p=f===l.firstElementChild?.firstElementChild?0:f.offsetTop-D(f,"margin-top"),u=v.offsetTop,c=0;const{start:I,end:T}=d[Number(f.dataset.line||0)];let h=m(I);const x=m(T+1===i.state.doc.lines?T:T+1);let S=0;if(x>t||v.offsetTop+v.offsetHeight>o){const M=w(t,o),E=l.querySelector(`[data-line="${M}"]`);p=E?E.offsetTop-D(E,"margin-top"):p,h=m(M),c=(g-p)/(o-p),S=t-h}else f===l.firstElementChild?.firstElementChild?(f===v&&(u=v.offsetTop+v.offsetHeight+ +getComputedStyle(v).marginBottom.replace("px","")),S=x,c=Math.max(g/u,0)):(c=Math.max((g-p)/(u-p),0),S=x-h);C(e,h+S*c,()=>{$--})},O=r=>{const{scrollDOM:g,contentHeight:H}=i,t=g.clientHeight;if(H<=t||l.firstElementChild.clientHeight<=l.clientHeight||i.state.doc.lines<=d[d.length-1]?.end)return!1;r.target===e?B():_()};return[()=>{N(),e.addEventListener("scroll",O),l.addEventListener("scroll",O),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",O),l.removeEventListener("scroll",O)}]},z={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},F=n.defineComponent({props:z,setup(e){const l=n.inject("scrollElementRef"),b=n.inject("roorNodeRef"),i=n.ref();n.watch(()=>e.tocItem.active,m=>{m&&e.onActive(e.tocItem,i.value)}),n.onMounted(()=>{e.tocItem.active&&e.onActive(e.tocItem,i.value)});const C=m=>{if(m.stopPropagation(),e.onClick(m,e.tocItem),m.defaultPrevented)return;const L=e.mdHeadingId({text:e.tocItem.text,level:e.tocItem.level,index:e.tocItem.index,currentToken:e.tocItem.currentToken,nextToken:e.tocItem.nextToken}),d=b.value.getElementById(L),s=l.value;if(d&&s){let a=d.offsetParent,N=d.offsetTop;if(s.contains(a))for(;a&&s!=a;)N+=a?.offsetTop,a=a?.offsetParent;const w=d.previousElementSibling;let A=0;w||(A=D(d,"margin-top")),s?.scrollTo({top:N-e.scrollElementOffsetTop-A,behavior:"smooth"})}};return()=>n.createVNode("div",{ref:i,class:[`${R.prefix}-catalog-link`,e.tocItem.active&&`${R.prefix}-catalog-active`],onClick:C},[n.createVNode("span",{title:e.tocItem.text},[e.tocItem.text]),e.tocItem.children&&e.tocItem.children.length>0&&n.createVNode("div",{class:`${R.prefix}-catalog-wrapper`},[e.tocItem.children.map(m=>n.createVNode(F,{mdHeadingId:e.mdHeadingId,key:`${e.tocItem.text}-link-${m.level}-${m.text}`,tocItem:m,onActive:e.onActive,onClick:e.onClick,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])}}),J={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},V=n.defineComponent({name:"MdCatalog",props:J,emits:["onClick","onActive"],setup(e,l){const b=e.editorId,i=`#${b}-preview-wrapper`,C=n.reactive({list:[],show:!1,scrollElement:e.scrollElement||i}),m=n.shallowRef(),L=n.ref(),d=n.ref(),s=n.ref(),a=n.ref(),N=n.shallowRef(),w=n.ref({});n.provide("scrollElementRef",d),n.provide("roorNodeRef",a);const A=n.computed(()=>{const t=[];return C.list.forEach((o,f)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:v,level:p,line:u}=o,c={level:p,text:v,line:u,index:f+1,active:m.value===o};if(t.length===0)t.push(c);else{let I=t[t.length-1];if(c.level>I.level)for(let T=I.level+1;T<=6;T++){const{children:h}=I;if(!h){I.children=[c];break}if(I=h[h.length-1],c.level<=I.level){h.push(c);break}}else t.push(c)}}),t}),$=()=>{if(C.scrollElement instanceof HTMLElement)return C.scrollElement;let t=document;return(C.scrollElement===i||e.isScrollElementInShadow)&&(t=L.value?.getRootNode()),t.querySelector(C.scrollElement)},B=t=>{if(t.length===0)return m.value=void 0,C.list=[],!1;const{activeHead:o,activeIndex:f}=t.reduce((u,c,I)=>{let T=0;if(e.syncWith==="preview"){const h=a.value?.getElementById(e.mdHeadingId({text:c.text,level:c.level,index:I+1,currentToken:c.currentToken,nextToken:c.nextToken}));h instanceof HTMLElement&&(T=G.getRelativeTop(h,d.value))}else{const h=N.value;if(h){const x=h.lineBlockAt(h.state.doc.line(c.line+1).from).top,S=h.scrollDOM.scrollTop;T=x-S}}return T<e.offsetTop&&T>u.minTop?{activeHead:c,activeIndex:I,minTop:T}:u},{activeHead:t[0],activeIndex:0,minTop:Number.MIN_SAFE_INTEGER});let v=o;const{catalogMaxDepth:p}=e;if(p&&v.level>p){for(let u=f;u>=0;u--){const c=t[u];if(c.level<=p){v=c;break}}if(v.level>p){const u=t.find(c=>c.level<=p);u&&(v=u)}}m.value=v,C.list=t},_=(t,o)=>{w.value.top=o.offsetTop+D(o,"padding-top")+"px",e.onActive?.(t,o),l.emit("onActive",t,o)},O=()=>{B(C.list)},r=t=>{if(s.value?.removeEventListener("scroll",O),e.syncWith==="editor")s.value=N.value?.scrollDOM;else{const o=$();d.value=o,s.value=o===document.documentElement?document:o}B(t),s.value?.addEventListener("scroll",O)},g=t=>{N.value=t};n.watch([()=>e.syncWith,N,()=>e.catalogMaxDepth],()=>{r(C.list)}),n.onMounted(()=>{a.value=L.value.getRootNode(),y.bus.on(b,{name:y.CATALOG_CHANGED,callback:r}),y.bus.on(b,{name:y.GET_EDITOR_VIEW,callback:g}),y.bus.emit(b,y.PUSH_CATALOG),y.bus.emit(b,y.SEND_EDITOR_VIEW)}),n.onBeforeUnmount(()=>{y.bus.remove(b,y.CATALOG_CHANGED,r),y.bus.remove(b,y.GET_EDITOR_VIEW,g),s.value?.removeEventListener("scroll",O)});const H=(t,o)=>{e.onClick?.(t,o),l.emit("onClick",t,o)};return()=>n.createVNode("div",{class:[`${R.prefix}-catalog`,e.theme==="dark"&&`${R.prefix}-catalog-dark`,e.class||""],ref:L},[A.value.length>0&&n.createVNode(n.Fragment,null,[n.createVNode("div",{class:`${R.prefix}-catalog-indicator`,style:w.value},null),n.createVNode("div",{class:`${R.prefix}-catalog-container`},[A.value.map(t=>n.createVNode(F,{mdHeadingId:e.mdHeadingId,tocItem:t,key:`link-${t.level}-${t.text}`,onActive:_,onClick:H,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});V.install=e=>(e.component(V.name,V),e);exports.MdCatalog=V;exports.scrollAuto=U;exports.scrollAutoWithScale=j;
